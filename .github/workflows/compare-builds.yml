name: Compare Build Outputs

on:
  workflow_run:
    workflows: ['Generate Docs']
    types: [completed]

permissions:
  contents: read
  actions: read
  pull-requests: write

jobs:
  get-comparators:
    name: Get Comparators
    runs-on: ubuntu-latest
    if: github.event.workflow_run.event == 'pull_request'
    outputs:
      comparators: ${{ steps.get-comparators.outputs.comparators }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout Code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: List comparators
        id: get-comparators
        run: |
          # List all .mjs files in scripts/compare-builds/ and remove the .mjs extension
          COMPARATORS=$(ls scripts/compare-builds/*.mjs | xargs -n1 basename | sed 's/\.mjs$//' | jq -R -s -c 'split("\n")[:-1]')
          echo "comparators=$COMPARATORS" >> $GITHUB_OUTPUT

  compare:
    name: Run ${{ matrix.comparator }} comparator
    runs-on: ubuntu-latest
    needs: get-comparators
    strategy:
      matrix:
        comparator: ${{ fromJSON(needs.get-comparators.outputs.comparators) }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout Code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Download Output (HEAD)
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: ${{ matrix.comparator }}
          path: out/head
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Run ID from BASE
        id: base-run
        env:
          WORKFLOW_ID: ${{ github.event.workflow_run.workflow_id }}
          GH_TOKEN: ${{ github.token }}
        run: |
          ID=$(gh run list -c $GITHUB_SHA -w $WORKFLOW_ID -L 1 --json databaseId --jq ".[].databaseId")
          echo "run_id=$ID" >> $GITHUB_OUTPUT

      - name: Download Output (BASE)
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: web
          path: out/base
          run-id: ${{ steps.base-run.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Compare Bundle Size
        id: compare
        run: |
          node scripts/compare-builds/${{ matrix.comparator }}.mjs > result.txt
          if [ -s result.txt ]; then
            echo "has_output=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_output=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload comparison artifact
        if: steps.compare.outputs.has_output == 'true'
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: ${{ matrix.comparator }}
          path: result.txt

  aggregate:
    name: Aggregate Comparison Results
    runs-on: ubuntu-latest
    needs: compare
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Download all comparison artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          path: results

      - name: Combine results
        id: combine
        run: |
          shopt -s nullglob
          result_files=(results/*.txt)

          if ((${#result_files[@]})); then
            {
              echo "combined<<EOF"
              cat "${result_files[@]}"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Add Comment to PR
        if: steps.combine.outputs.combined
        uses: thollander/actions-comment-pull-request@24bffb9b452ba05a4f3f77933840a6a841d1b32b # v3.0.1
        with:
          comment-tag: compared
          message: ${{ steps.combine.outputs.combined }}
          pr-number: ${{ github.event.workflow_run.pull_requests[0].number }}
